@model ThueXeVn.Models.driver
@{
    string url = Request.Url.Authority + HttpContext.Current.Request.RawUrl.ToString();
    long driverId = 0;
    if (Request.ServerVariables["HTTPS"] == "on")
    {
        url = "https://" + url;
    }
    else
    {
        url = "http://" + url;
    }

    if (ViewBag.driverId != null)
    {
        driverId = ViewBag.driverId;
    }
}

<link href="~/Content/sld/flexslider.css" rel="stylesheet" />
<link href="~/Content/bootstrap-rating.css" rel="stylesheet" />
<link href="~/Content/PagedList.css" rel="stylesheet" />
<link rel="stylesheet" type="text/css" href="/Content/jquery.datetimepicker.css" />
<script src="~/Content/sld/jquery.flexslider-min.js"></script>
<script src="~/Content/bootstrap-rating.min.js"></script>
<script src="/Scripts/jquery.datetimepicker.js"></script>

<style>
    .item_profile ul {
        list-style-type: none;
        padding: 0;
        font-size: 14px;
    }

    .item_profile ul li {
        padding-left: 10px;
    }

</style>

<div id="fb-root"></div>
<script>
(function(d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0];
    if (d.getElementById(id)) return;
    js = d.createElement(s); js.id = id;
    js.src = "//connect.facebook.net/vi_VN/sdk.js#xfbml=1&version=v2.8&appId=404216066584603";
    fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>

@{
    Layout = "~/Views/Shared/_LayoutProfile.cshtml";
    ViewBag.title = "Trang nhà xe";
    ViewBag.des = "Trang nhà xe";
    ViewBag.keywords = "";
    ViewBag.url = @url;
}



@if (Model != null)
{
    ViewBag.title += " " + @Model.name;
    ViewBag.des += " " + @Model.name;
}

<div id="content" style="color: #333; background: #fff;">
    @if (Model != null)
    {
        <div class="container-fluid">
            <div class="row">
                @{Html.RenderAction("LoadAlbumDriver", new { driver_id = Model.id });}
            </div>
        </div>
    <div style="background: #f5f5f5 url(/Images/bg_profile.jpg) no-repeat center center;background-size: cover;">
        <div class="container">

            <div class="row">
                <div class="col-md-7">
                    <div class="row item_profile item_profile_first">
                        <div class="col-sm-3">
                            <h3>
                                @if (Model.driver_type == 0)
                                {<text>Tài xế</text>}
                                else
                                {<text>Nhà xe</text>}:
                            </h3>

                        </div>
                        <div class="col-sm-9">
                            <h3>@Model.name</h3>
                            @if (Model.address != null && Model.address != "")
                            {
                                <address><i class="fa fa-address-card"></i> @Model.address <a href="#map-canvas"> - Xem bản đồ</a></address>
                            }
                            <p>Xe @Model.car_made @Model.car_model @Model.car_years</p>
                            @{Html.RenderAction("TotalDanhGia", new { id = Model.id });}
                        </div>
                    </div>

                    @{Html.RenderAction("LoadBangGiaDriver", new { driver_id = Model.id });}
                    @{Html.RenderAction("LoadDesDriver", new { driver_id = Model.id });}

                </div>
                <div class="col-md-5 sidebar">
                    <div>
                        <h3 class="profile_gia">
                            Giá trung bình:&nbsp;
                            @if (Model.car_price == -1)
                            {
                                <text>thỏa thuận.</text>
                            }
                            else
                            {
                                <text>@string.Format("{0:#,###} đồng/km.", Model.car_price)</text>
                            }
                        </h3>
                    </div>
                    @*Datxe*@
                    <form class="form-horizontal form_profile" method="post" id="form_dat_thue_xe" name="form_dat_thue_xe" enctype="multipart/form-data">

                        <div class="text-center">
                            <h1 style="color: #03a9f4;">Liên hệ ngay</h1>
                            <a href="tel:@Model.phone" class="btn btn-info">@Model.phone</a>
                        </div>
                        
                        <input type="hidden" name="driver_id" id="driver_id" value="@Model.id" />
                        <input type="hidden" name="driver_name" id="driver_name" value="@Model.name" />
                        <input type="hidden" name="car_hire_type" id="car_hire_type" value="Một chiếu" />
                        <input type="hidden" name="car_type_made_model" id="car_type_made_model" value="@Model.car_type @Model.car_model @Model.car_years" />
                        <input type="hidden" name="price_driver" id="price_driver" value="@Model.car_price" />
                        <input type="hidden" name="distance" id="distance" />
                        <input type="hidden" name="total_money" id="total_money" />
                        
                        <div class="form-group">
                            <div class="col-sm-6">
                                <label class="control-label">Họ tên khách: </label>
                                <input name="customer_name" id="customer_name" class="form-control" placeholder="Tên khách hàng" />
                            </div>
                            <div class="col-sm-6">
                                <label class="control-label">Số điện thoại: </label>
                                <input name="customer_phone" id="customer_phone" class="form-control" placeholder="Số điện thoại khách hàng" />
                            </div>
                        </div>

                        <div class="form-group">
                            <div class="col-sm-6">
                                <label class="control-label">Điểm đi: </label>
                                <input name="from_place" id="from_place" class="form-control" placeholder="Điểm đi" />
                            </div>
                            <div class="col-sm-6">
                                <label class="control-label">Điểm đến: </label>
                                <input name="to_place" id="to_place" class="form-control" placeholder="Điểm đến" />
                            </div>
                            <input type="hidden" name="lon_from" id="lon_from" value="" />
                            <input type="hidden" name="lat_from" id="lat_from" value="" />
                            <input type="hidden" name="lon_to" id="lon_to" value="" />
                            <input type="hidden" name="lat_to" id="lat_to" value="" />
                        </div>

                        <div class="form-group">
                            <div class="col-sm-6">
                                <label class="control-label">Từ ngày: </label>
                                <input name="from_date" id="from_date" class="form-control" placeholder="Từ ngày" />
                            </div>
                            <div class="col-sm-6">
                                <label class="control-label">Đến ngày: </label>
                                <input name="to_date" id="to_date" class="form-control" placeholder="Đến ngày" />
                            </div>
                        </div>

                        <div class="form-group">
                            <div class="col-sm-12">
                                <label class="control-label">Loại xe: </label>
                                <select class="form-control" id="car_size_driver" name="car_size_driver" onchange="getcpdriver(@Model.id);">
                                    <option value="">Tất cả loại xe</option>
                                </select>
                            </div>
                        </div>

                        

                        <div class="form-group">
                            <div class="col-sm-12">
                                <button type="button" style="background: #03a9f4;border-color: #03a9f4;border-radius: 0;" class="btn btn-lg btn-primary btn-block" id="btn_bookingtodriver" onclick="saveBookingToDriver(@Model.id);">Đặt xe</button>
                            </div>
                        </div>

                    </form>

                </div>



            </div>


        </div>
    </div>
        <div class="container">
            <div class="row">
                <div id="panel_danhgia">
                    <div class="col-md-4">
                        <h3>Gửi đánh giá và nhận xét</h3>

                        <form name="addcomment" id="addcomment" method="post" enctype="multipart/form-data">
                            <div class="form-group">
                                <label>Đánh giá nhà xe: </label>
                                <input type="hidden" class="rating-tooltip cus_rate" id="cus_rate" name="cus_rate" data-filled="fa fa-star fa-2x fa_red" data-empty="fa fa-star-o fa-2x fa_red" data-fractions="1"> <span id="cus_rate_number"></span>
                            </div>

                            <input type="hidden" name="cus_driver_id" id="cus_driver_id" value="@driverId" />
                            <input type="hidden" name="cus_cm_id" id="cus_cm_id" value="0" />
                            <div class="form-group">
                                <label for="cus_name">Họ tên:</label>
                                <input type="text" name="cus_name" id="cus_name" class="form-control" placeholder="Họ tên" />
                            </div>

                            <div class="form-group">
                                <label for="cus_email">Email:</label>
                                <input type="email" name="cus_email" id="cus_email" class="form-control" placeholder="Email:" />
                            </div>

                            <div class="form-group">
                                <label for="cus_phone">Số điện thoại:</label>
                                <input type="text" name="cus_phone" id="cus_phone" class="form-control" placeholder="Số điện thoại:" />
                            </div>

                            <div class="form-group">
                                <label for="cus_comment">Bình luận:</label>
                                <textarea rows="5" name="cus_comment" id="cus_comment" class="form-control" placeholder="Bình luận"></textarea>
                            </div>

                            <button class="btn btn-primary" type="button" onclick="addCommentdriver();" id="btnaddComment">Gửi bình luận</button>

                        </form>

                    </div>
                    @*@{Html.RenderAction("LoadCommentDriver", new { driver_id = Model.id });}*@
                    <div class="col-md-8">
                        <div class="comment_driver">
                            @{Html.RenderAction("LoadCommentDriver", new { driver_id = Model.id });}
                        </div>
                    </div>


                    @*<div class="col-md-8">
                            <div class="comment_driver">
                                <h3>Danh sách nhận xét</h3>
                                <ul id="comment_driver_list">

                                </ul>
                            </div>
                        </div>*@


                </div>
            </div>
        </div>

        if (ViewBag.lon != null && ViewBag.lat != null)
        {
            <div class="container-fluid" style="margin-top: 10px;">
                <div class="row">
                    <div class="map-canvas" id="map-canvas"></div>
                </div>
            </div>
        }

        <div class="container" style="margin-top: 10px; margin-bottom: 10px;">
            <div class="row">
                <div class="col-md-12">
                    <h3>Thảo luận</h3>
                    <div id="fb_page">
                        <div class="fb-comments" data-href="@url" data-numposts="5"></div>
                    </div>
                </div>
            </div>
        </div>

    }
</div>

<div id="map-canvas" style="display: none;">
    Bản đồ
</div>

@section scripts {
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDLPSKQ4QV4xGiQjnZDUecx-UEr3D0QePY&libraries=places" type="text/javascript"></script>
    <script src="/Scripts/jquery.geocomplete.js"></script>
    <script>

        $(document).ready(function () {

            $('.album_driver').flexslider({
                animation: Modernizr.touch ? "slide" : "fade",
                animationSpeed: Modernizr.touch ? 400 : 1000,
                controlNav: false,
                directionNav: true,
                draggable: true,
            });

            //$('.danh_gia_chung').rating({
            //    extendSymbol: function (rate) {
            //        $(this).tooltip({
            //            container: 'body',
            //            placement: 'bottom',
            //            title: 'Đánh giá ' + rate + ' sao.'
            //        });
            //    }
            //});

            //$('.danh_gia_chung').rating({

            //    extendSymbol: function () {
            //        var title;
            //        $(this).tooltip({
            //            container: 'body',
            //            placement: 'bottom',
            //            trigger: 'manual',
            //            title: function () {
            //                return title;
            //            }
            //        });
            //        $(this).on('rating.rateenter', function (e, rate) {
            //            title = 'Đánh giá ' + rate + ' sao.';
            //            $(this).tooltip('show');
            //        })
            //        .on('rating.rateleave', function () {
            //            $(this).tooltip('hide');
            //        });
            //    }
            //});


            $('.danh_gia_chung').on('change', function () {
                $('#danh_gia_chung_n').html($(this).val() + ' sao.');
            })

            $('#cus_rate').rating({

                extendSymbol: function () {
                    var title;
                    $(this).tooltip({
                        container: 'body',
                        placement: 'bottom',
                        trigger: 'manual',
                        title: function () {
                            return title;
                        }
                    });
                    $(this).on('rating.rateenter', function (e, rate) {
                        title = 'Đánh giá ' + rate + ' sao.';
                        $(this).tooltip('show');
                    })
                    .on('rating.rateleave', function () {
                        $(this).tooltip('hide');
                    });
                }
            });

            $('#cus_rate').on('change', function () {
                $('#cus_rate_number').html($(this).val() + ' sao.').fadeIn();
                addCommentdriver();
                $('#cus_name').focus();
            })

            //Loaixe_socho
            $.ajax({
                url: "/Home/getCarSize",
                cache: false
            }).done(function (html) {
                $('#car_size_driver').append(html);
            });

            //$(document).on("click", "#contentPager a[href]", function () {
            //    $.ajax({
            //        url: $(this).attr("href"),
            //        type: 'GET',
            //        cache: false,
            //        success: function (result) {
            //            $('#content').html(result);
            //        }
            //    });
            //    return false;
            //});

        })


        function getcpdriver(id) {
            if (id) {
                var _loaixe = document.getElementById('car_size_driver').value;
                if (_loaixe != "") {
                    $.ajax({
                        url: "/Home/getcpdriver?id="+id + "&socho=" + _loaixe,
                        cache: false
                    }).done(function (html) {
                        $('#price_driver').val(html);
                        var so1 = parseFloat(html);
                        var so2 = parseFloat(document.getElementById("distance").value);
                        document.getElementById("total_money").value = so1 * so2;
                    });
                }else {

                }
                
            }
        }
        

        function addCommentdriver() {
            var url = "/Home/addCommentdriver"; // the script where you handle the form input.
            if ($('#cus_name').val() === "") {
                alert("Vui lòng nhập họ tên.");
                $('#cus_name').focus();
                return false;
            }
            if ($('#cus_email').val() === "") {
                alert("Vui lòng nhập email.");
                $('#cus_email').focus();
                return false;
            }
            if ($('#cus_phone').val() === "") {
                alert("Vui lòng nhập số điện thoại.");
                $('#cus_phone').focus();
                return false;
            }
            if ($('#cus_comment').val() === "") {
                alert("Vui lòng nhập bình luận.");
                $('#cus_comment').focus();
                return false;
            }
            $.ajax({
                type: "POST",
                url: url,
                data: $("#addcomment").serialize(), // serializes the form's elements.
                success: function (data) {
                    if (data !== "") {
                        alert('Đánh giá và nhận xét của bạn đã được gửi thành công.');
                        $('#cus_cm_id').val(data);
                        $('#btnaddComment').addClass('disabled');
                        $('.comment_driver').append('<div class="alert alert-success">Đánh giá và nhận xét của bạn đã được gửi thành công.</div>');
                    }
                }
            });
        }

        function danh_gia_r(x, y) {
            var url = "/Home/danh_gia_cm";
            $.ajax({
                type: "POST",
                url: url,
                data: { id: x, v: y }, // serializes the form's elements.
                success: function (data) {
                    if (data !== "") {
                        $('#vote_cm_' + x).html('<span class="helpful_btn_state">Cám ơn phản hồi của bạn!</span>');
                    }
                }
            });
        }

        $('#from_date').datetimepicker({dayOfWeekStart: 1,lang: 'en',
            disabledDates: ['1986/01/08', '1986/01/09', '1986/01/10'],
            startDate: '@DateTime.Now.Year/@DateTime.Now.Month/@DateTime.Now.Date'
        });
        $('#to_date').datetimepicker({
            dayOfWeekStart: 1,
            lang: 'en',
            disabledDates: ['1986/01/08', '1986/01/09', '1986/01/10'],
            startDate: '@DateTime.Now.Year/@DateTime.Now.Month/@DateTime.Now.Date'
        });
        var d = new Date();
        var s = d.toLocaleString();
        $('#from_date').datetimepicker({ value: s, step: 10 });

        $.ajax({
            url: "/Api/getListCarType",
            cache: false
        }).done(function (html) {
            var news = '{"news":' + html + '}';
            var json_parsed = $.parseJSON(news);
            $("#car_type_made_model").html("");
            for (var i = 0; i < json_parsed.news.length; i++) {
                if (json_parsed.news[i]) {
                    var name = json_parsed.news[i].name;
                    $("#car_type_made_model").append("<option value='" + name + "'>" + name + "</option>");
                }
            }
        });

        $.ajax({
            url: "/Api/getCarHireType",
            cache: false
        }).done(function (html) {
            var news = '{"news":' + html + '}';
            var json_parsed = $.parseJSON(news);
            $("#car_hire_type").html("");
            for (var i = 0; i < json_parsed.news.length; i++) {
                if (json_parsed.news[i]) {
                    var name = json_parsed.news[i].name;
                    $("#car_hire_type").append("<option value='" + name + "'>" + name + "</option>");
                }
            }
        });

        var options = {
            map: "#map-canvas"
        };
        $("#from_place").geocomplete(options)
      .bind("geocode:result", function (event, result) {
          $("#lat_from").val(result.geometry.location.lat());
          $("#lon_from").val(result.geometry.location.lng());
          search_khoangcach();
          //alert("long" + result.geometry.location.lng() + ", lat=" + result.geometry.location.lat());
      })
      .bind("geocode:error", function (event, status) {
          $.log("ERROR: " + status);
      })
      .bind("geocode:multiple", function (event, results) {
          $.log("Multiple: " + results.length + " results found");
      });

        $("#to_place").geocomplete(options)
          .bind("geocode:result", function (event, result) {
              $("#lat_to").val(result.geometry.location.lat());
              $("#lon_to").val(result.geometry.location.lng());
              search_khoangcach();
              //alert("long" + result.geometry.location.lng() + ", lat=" + result.geometry.location.lat());
          })
          .bind("geocode:error", function (event, status) {
              $.log("ERROR: " + status);
          })
          .bind("geocode:multiple", function (event, results) {
              $.log("Multiple: " + results.length + " results found");
          });


        function search_khoangcach() {
            if (document.getElementById('lat_from').value != "" && document.getElementById('lon_from').value != "" && document.getElementById('lat_to').value != "" && document.getElementById('lon_to').value != "") {
            
                var directionsDisplay = new google.maps.DirectionsRenderer;
                var directionsService = new google.maps.DirectionsService;

                var selectedMode = "DRIVING";
                //var khoangcach = "";
                var latlng1 = new google.maps.LatLng(document.getElementById('lat_from').value, document.getElementById('lon_from').value);
                var latlng2 = new google.maps.LatLng(document.getElementById('lat_to').value, document.getElementById('lon_to').value);
                console.log(latlng1);
                console.log(latlng2);
                directionsService.route({
                    origin: latlng1,  // Diem di.
                    destination: latlng2,  // Diem den
                    // Note that Javascript allows us to access the constant
                    // using square brackets and a string value as its
                    // "property."
                    travelMode: google.maps.TravelMode[selectedMode]
                }, function (response, status) {
                    if (status == 'OK') {
                        directionsDisplay.setDirections(response);
                        var khoangcach = response.routes[0].legs[0].distance.text.replace(/km/g, "").replace(/m/g, "").replace(",",".").trim();
                    
                        var _gia1 = document.getElementById("price_driver").value;
                        var so1 = parseFloat(khoangcach);
                        var so2 = parseFloat(_gia1);
                        document.getElementById("distance").value = so1;
                        document.getElementById("total_money").value = so1 * so2;
                    } else {
                        console.log(status);
                    }
                });
            }
        }

        //Loaixe_socho
        //$.ajax({
        //    url: "/Home/getCarSize",
        //    cache: false
        //}).done(function (html) {
        //    $('#car_type_made_model').append(html);
        //});

        function saveBookingToDriver(id) {
            var url = "/Home/saveBookingToDriver"; // the script where you handle the form input.
            if (document.getElementById('customer_name').value === "") {
                alert("Vui lòng nhập họ tên khách hàng.");
                document.getElementById('customer_name').focus();
                return false;
            }
            if (document.getElementById('customer_phone').value === "") {
                alert("Vui lòng nhập số điện thoại khách hàng.");
                document.getElementById('customer_phone').focus();
                return false;
            }
            if (document.getElementById('from_date').value === "") {
                alert("Vui lòng nhập ngày đến.");
                document.getElementById('from_date').focus();
                return false;
            }
            if (document.getElementById('to_date').value === "") {
                alert("Vui lòng nhập ngày đi.");
                document.getElementById('to_date').focus();
                return false;
            }
            if (document.getElementById('from_date').value > document.getElementById('to_date').value) {
                alert("Ngày đi phải sau ngày đến");
                document.getElementById('from_date').focus();
                return false;
            }
            if (document.getElementById('lon_from').value === "" && document.getElementById('lat_from').value === "") {
                alert("Vui lòng nhập lại điểm đi.");
                document.getElementById('from_place').focus();
                return false;
            }

            if (document.getElementById('lon_to').value === "" && document.getElementById('lat_to').value === "") {
                alert("Vui lòng nhập lại điểm đến.");
                document.getElementById('to_place').focus();
                return false;
            }

            if (document.getElementById('car_size_driver').value === "") {
                alert("Vui lòng chọn loại xe muốn đặt.");
                document.getElementById('car_size_driver').focus();
                return false;
            }
            
            document.getElementById("btn_bookingtodriver").innerHTML = "Đang đặt xe xin chờ....";
            document.getElementById("btn_bookingtodriver").disabled = true;
            $.ajax({
                type: "POST",
                url: url,
                data: $("#form_dat_thue_xe").serialize(), // serializes the form's elements.
                success: function (data) {
                    if (data == 1) {
                        document.getElementById('customer_name').value = "";
                        document.getElementById('customer_phone').value = "";
                        document.getElementById('to_date').value = "";
                        var d = new Date();
                        var s = d.toLocaleString();
                        $('#from_date').datetimepicker({ value: s, step: 10 });

                        alert('Đã đặt xe thành công.');
                        document.getElementById("btn_bookingtodriver").innerHTML = "Đặt xe";
                        document.getElementById("btn_bookingtodriver").disabled = false;
                    }
                    //console.log(data);
                }
            });
        }

    </script>


@if (ViewBag.lon != null && ViewBag.lat != null)
{

    <!--Map JavaScript-->
    <script>
        initmap();
        function initmap() {
            var myVitri = new google.maps.LatLng(@ViewBag.lat, @ViewBag.lon);
            var map = new google.maps.Map(document.getElementById('map-canvas'), {
                center: { lat: myVitri.lat(), lng: myVitri.lng() },
                zoom: 14,
                draggable: true,
                scrollwheel: false,
                mapTypeId: google.maps.MapTypeId.ROADMAP,
                animation: google.maps.Animation.DROP,
            });

            var infoWindow = new google.maps.InfoWindow({ map: map });
            var pos = {
                lat: myVitri.lat(),
                lng: myVitri.lng()
            };

            infoWindow.setPosition(pos);
            infoWindow.setContent('<i class="fa fa-car fa-2x"></i> @Html.Raw(Model.name + ", <br /> Địa chỉ: " + Model.address)');
            map.setCenter(pos);

        }
    </script>

}
}
